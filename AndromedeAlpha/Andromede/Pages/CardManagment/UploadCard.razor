@*
    *
    * (c) 2021-2021 Copyright Andromede
    * Unauthorized use and disclosure strictly forbidden
    *
*@
@page "/CardManagment/UploadCard"
@inject IJSRuntime jsRuntime
@inject NavigationManager NavManager
@inherits OwningComponentBase

<AuthorizeView>
    <Authorized Context="_authContext">
        @if (GetAuthRestorer(_authContext.User.Identity.Name) != null)
        {
            <div class="top-row px-2 centered-title">
                <img class="small centered-image bottom-divider" src="img/andromede_white_bg.png" />
                <h5>Veuillez nous envoyer votre carte afin de générer la numérisation</h5>
                <h5 class="bottom-divider">Format accepté :</h5>
                <img class="small centered-image" src="img/ico/pdf.png" />
            </div>

            <div class="drag-drop-zone">
                <BlazorInputFile.InputFile OnChange="ViewFile" accept="application/pdf,application/vnd.ms-excel" />
                Glissez un fichier ou cliquez pour déposer une fichier
            </div>

            <div class="centered-title top-divider bottom-divider">
                <h6>@_infos</h6>
                @if (_isFileCorrect)
                {
                    <button class="btn btn-andromede top-divider" @onclick="CardUploaded">Valider l'envoi du fichier</button>
                }
                @if (_isLoading)
                {
                    <div class="spinner-border text-andromede" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                }
            </div>
        }
    </Authorized>
</AuthorizeView>


@code {
    private const int MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    private const int MAX_FILE_SIZE_MB = 10;

    private string _infos;

    private bool _isFileCorrect;
    private bool _isLoading;

    private IFileListEntry _fileToUpload;

    private Restorer _authRestorer;

    private List<string> acceptedFileTypes;



    private IRestorerRepository _restorerRepository;

    protected override void OnInitialized()
    {
        _restorerRepository = ScopedServices.GetRequiredService<IRestorerRepository>();
        acceptedFileTypes   = new List<string>() { "application/pdf", "application/vnd.ms-excel" };
        _isLoading = false;
    }

    private Restorer GetAuthRestorer(string iId)
    {
        _authRestorer = _restorerRepository.GetRestorerWithId(int.Parse(iId));
        return _authRestorer;
    }

    private async Task ViewFile(IFileListEntry[] files)
    {
        _isLoading = true;
        _fileToUpload = files.FirstOrDefault();
        if (_fileToUpload == null)
        {
            return;
        }
        else if (_fileToUpload.Size > MAX_FILE_SIZE)
        {
            _infos = $"Le fichier est trop gros. La taille maximale est : {MAX_FILE_SIZE_MB} MB.";
            _isFileCorrect = false;
        }
        else if (!acceptedFileTypes.Contains(_fileToUpload.Type))
        {
            _infos = "Seuls les fichiers de type PDF sont acceptés";
            _isFileCorrect = false;
        }
        else
        {
            using (var reader = new StreamReader(_fileToUpload.Data))
            {
                _infos = _fileToUpload.Name;
            }
            _isFileCorrect = true;
        }
        _isLoading = false;
    }

    private async void CardUploaded()
    {
        _isFileCorrect = false;
        _infos = "Le fichier a été correctement ajouté au serveur Andromede.\nVous pouvez désormais télécharger vos QR Codes";
        string aRestaurantSiretNumber = _authRestorer.RestaurantSiretNumber;
        try
        {
            Stream aFileToUploadStream = _fileToUpload.Data;
            var aFileToUploadPath = $"wwwroot/Cards/{aRestaurantSiretNumber}.pdf";
            FileStream aFileStream = File.Create(aFileToUploadPath);
            await aFileToUploadStream.CopyToAsync(aFileStream);
            aFileToUploadStream.Close();
            aFileStream.Close();
        }
        catch (Exception e)
        {
            _infos = "Une erreur est survenue, nous sommes désolé pour la gêne occasionnée, veuillez réessayer l'opération.";
        }
    }
}


<style>
    .drag-drop-zone {
        border: 3px dashed #511621;
        border-radius: 1rem;
        padding: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        background-color: #eee;
        box-shadow: inset 0 0 8px rgba(0,0,0,0.2);
        color: #aeaeae;
        font-size: 1.5rem;
        cursor: pointer;
        margin: 5% 15% 0 15%;
        position: relative;
    }

        .drag-drop-zone:hover {
            background-color: #f5f5f5;
        }

        .drag-drop-zone input[type=file] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
</style>
