@inject IJSRuntime jsRuntime
@inject NavigationManager NavManager
@inherits OwningComponentBase
@using Tools;

@if (!_formSubmitted)
{
    <EditForm Model="@_askedRestorer" OnValidSubmit="@ResetAsked">
        <div class="form-row connexion-div top-divider">
            <div class="form-group col-sm-2"></div>
            <div class="form-group col-sm-8">
                <label for="emailAddress"><span class="oi oi-person form-icon"></span>Adresse mail</label>
                <InputText type="text" class="form-control" id="emailAddress" @bind-Value="_askedRestorer.EmailAddress" />
                <ValidationMessage For="@(() => _askedRestorer.EmailAddress)" />
            </div>
            <div class="form-group col-sm-2"></div>
        </div>
        <div class="centered-title bottom-divider">
            <button type="submit" class="btn btn-andromede">Envoyer</button>
        </div>
    </EditForm>
}
else
{
    <h6 class="bottom-divider">Un email a été envoyé si vous avez correctement rentré votre adresse.<br /> Vous avez 4H pour changer votre mot de passe. <br /> Vérifiez également vos spams.</h6>
    <div class="centered-title bottom-divider">
        <button class="btn btn-andromede" @onclick="CloseResetPasswordModal">Fermer</button>
    </div>
}

@code {
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }

    private RestorerClaim _currentRestorerClaim;
    private Restorer _askedRestorer;

    bool _formSubmitted;

    public IRestorerRepository _restorerRepository { get; set; }
    public IRestorerClaimRepository _restorerClaimRepository { get; set; }

    protected override void OnInitialized()
    {
        _restorerRepository = ScopedServices.GetRequiredService<IRestorerRepository>();
        _restorerClaimRepository = ScopedServices.GetRequiredService<IRestorerClaimRepository>();
        _askedRestorer = new Restorer();
        _currentRestorerClaim = new RestorerClaim();
        _formSubmitted = false;
    }

    async Task ResetAsked()
    {
        _formSubmitted = true;

        _askedRestorer = _restorerRepository.GetRestorerWithEmailAddress(_askedRestorer.EmailAddress);
        if(_askedRestorer == null)
            return;
        _currentRestorerClaim = RestorerClaimGenerator.GenerateRestorerClaim(_askedRestorer.RestorerId);
        _restorerClaimRepository.NewRestorerClaim(_currentRestorerClaim);
        await ResetPasswordMailSender.SendMail(_currentRestorerClaim, _askedRestorer);
    }

    async Task CloseResetPasswordModal()
    {
        await ModalInstance.CancelAsync();
    }
}
